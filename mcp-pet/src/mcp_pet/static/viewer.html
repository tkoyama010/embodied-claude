<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>mcp-pet viewer</title>
  <script src="https://cdn.webrtc.ecl.ntt.com/skyway-4.4.5.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #0a0a0a;
      color: #e8e0d0;
      font-family: 'Helvetica Neue', sans-serif;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #video-area {
      flex: 1;
      position: relative;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #video-area video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    #no-stream {
      color: #666;
      font-size: 18px;
      text-align: center;
      line-height: 1.6;
    }
    #status-bar {
      width: 100%;
      padding: 8px 16px;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 40px;
    }
    #indicator {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #444;
      flex-shrink: 0;
    }
    #indicator.waiting { background: #c8a84b; animation: pulse 1.5s infinite; }
    #indicator.connected { background: #4caf50; }
    #indicator.live { background: #4caf50; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    #status-text { font-size: 13px; color: #aaa; flex: 1; }
    #mode-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #333;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    #mode-badge.active { background: #1a3a4a; color: #6bc; }
    #direction-panel {
      width: 100%;
      padding: 16px;
      background: rgba(20, 15, 5, 0.95);
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #direction-text {
      font-size: 22px;
      font-weight: bold;
      color: #f5c842;
      text-align: center;
      letter-spacing: 0.05em;
    }
    #controls {
      padding: 12px 16px;
      background: #111;
      display: flex;
      gap: 12px;
    }
    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
    }
    button:active { opacity: 0.7; }
    button:disabled { opacity: 0.4; cursor: default; }
    #btn-create { background: #c8a84b; color: #000; }
    #btn-leave { background: #444; color: #ccc; }
    #log {
      padding: 8px 16px 12px;
      background: #0a0a0a;
      font-size: 11px;
      color: #555;
      max-height: 80px;
      overflow-y: auto;
      font-family: monospace;
    }
  </style>
</head>
<body>

<div id="video-area">
  <div id="no-stream">ルームを作成して<br>スマホからの配信を待機</div>
</div>

<div id="status-bar">
  <div id="indicator"></div>
  <div id="status-text">未接続</div>
  <div id="mode-badge"></div>
</div>

<div id="direction-panel">
  <div id="direction-text">——</div>
</div>

<div id="controls">
  <button id="btn-create">ルーム作成</button>
  <button id="btn-leave">停止</button>
</div>

<div id="log"></div>

<script>
// Derive base path from current URL (works at / or /embodied/)
const basePath = location.pathname.replace(/\/[^/]*$/, '') || '';

const videoArea = document.getElementById('video-area');
const noStream = document.getElementById('no-stream');
const indicator = document.getElementById('indicator');
const statusText = document.getElementById('status-text');
const modeBadge = document.getElementById('mode-badge');
const directionText = document.getElementById('direction-text');
const logEl = document.getElementById('log');

let peer = null;
let room = null;
let ws = null;

function log(msg) {
  const ts = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.textContent = ts + ' ' + msg;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
  console.log('[viewer]', msg);
}

// SkyWay mesh で receive-only 参加する場合、ダミーストリームを
// 渡さないと stream イベントが発火しないことがある
function createDummyStream() {
  const canvas = document.createElement('canvas');
  canvas.width = 1;
  canvas.height = 1;
  const ctx = canvas.getContext('2d');
  ctx.fillRect(0, 0, 1, 1);
  return canvas.captureStream(0);
}

// WebSocket for server events (saved, direction)
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + basePath + '/ws');

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'direction') {
      directionText.textContent = data.text;
    } else if (data.type === 'saved') {
      log('frame saved: ' + data.timestamp);
    } else if (data.type === 'connected') {
      log('WS: ' + data.message + ' (mode: ' + data.mode + ')');
    }
  };

  ws.onclose = () => {
    setTimeout(connectWS, 3000);
  };
}

document.getElementById('btn-create').addEventListener('click', async () => {
  const btn = document.getElementById('btn-create');
  btn.disabled = true;
  statusText.textContent = '接続中...';

  try {
    const res = await fetch(basePath + '/config');
    const { skywayKey, roomName } = await res.json();

    if (!skywayKey) {
      statusText.textContent = 'SkyWay未設定 (PET_SKYWAY_KEY)';
      btn.disabled = false;
      return;
    }

    log('SkyWay key: ....' + skywayKey.slice(-4) + ', room: ' + roomName);

    peer = new Peer({ key: skywayKey });

    peer.on('open', (id) => {
      log('Peer ID: ' + id);
      statusText.textContent = 'ルーム作成中...';

      const dummyStream = createDummyStream();
      room = peer.joinRoom(roomName, { mode: 'mesh', stream: dummyStream });

      room.on('open', () => {
        indicator.className = 'waiting';
        statusText.textContent = 'ルーム "' + roomName + '" 作成済み — スマホの配信を待機中';
        modeBadge.textContent = 'VIEWER';
        modeBadge.className = 'active';
        noStream.textContent = 'スマホから「配信開始」を押してください';
        log('Room created: ' + roomName);
        connectWS();
      });

      room.on('peerJoin', (peerId) => {
        log('peer joined: ' + peerId);
        statusText.textContent = '配信者が参加しました';
      });

      room.on('stream', (stream) => {
        log('stream received from: ' + stream.peerId);
        noStream.style.display = 'none';

        // 既存のビデオ要素があれば削除
        const existing = videoArea.querySelector('[data-peer-id="' + stream.peerId + '"]');
        if (existing) existing.remove();

        const video = document.createElement('video');
        video.srcObject = stream;
        video.setAttribute('data-peer-id', stream.peerId);
        video.autoplay = true;
        video.playsInline = true;
        video.muted = true;
        videoArea.appendChild(video);
        video.play().catch(err => log('play error: ' + err.message));

        indicator.className = 'live';
        statusText.textContent = 'ライブ映像受信中';
      });

      room.on('peerLeave', (peerId) => {
        log('peer left: ' + peerId);
        const video = videoArea.querySelector('[data-peer-id="' + peerId + '"]');
        if (video) video.remove();
        if (!videoArea.querySelector('video')) {
          noStream.style.display = '';
          noStream.textContent = '配信者が退出しました — 再接続を待機中';
          indicator.className = 'waiting';
          statusText.textContent = '待機中';
        }
      });

      room.on('error', (err) => {
        log('Room error: ' + err.message);
        statusText.textContent = 'SkyWayエラー: ' + err.message;
      });
    });

    peer.on('error', (err) => {
      log('Peer error: ' + err.type);
      statusText.textContent = 'Peer エラー: ' + err.type;
      btn.disabled = false;
    });
  } catch (err) {
    log('Error: ' + err.message);
    statusText.textContent = 'エラー: ' + err.message;
    btn.disabled = false;
  }
});

document.getElementById('btn-leave').addEventListener('click', () => {
  if (ws) { ws.close(); ws = null; }
  if (room) { room.close(); room = null; }
  if (peer) { peer.destroy(); peer = null; }
  videoArea.querySelectorAll('video').forEach(v => v.remove());
  noStream.style.display = '';
  noStream.textContent = 'ルームを作成して\nスマホからの配信を待機';
  indicator.className = '';
  statusText.textContent = '停止済み';
  modeBadge.textContent = '';
  modeBadge.className = '';
  directionText.textContent = '——';
  document.getElementById('btn-create').disabled = false;
  log('stopped');
});
</script>
</body>
</html>
